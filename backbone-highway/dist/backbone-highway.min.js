!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],b):(a.Backbone=a.Backbone||{},a.Backbone.Highway=b(a._,a.Backbone))}(this,function(a,b){"use strict";function n(b){this.definition=a.extend({},l,b),this.configure()}a="default"in a?a.default:a,b="default"in b?b.default:b;var c={headingSlash:/^(\/|#)/,trailingSlash:/\/$/,parentheses:/[\(\)]/g,optionalParams:/\((.*?)\)/g,splatParams:/\*\w+/g,namedParam:/(\(\?)?:\w+/,namedParams:/(\(\?)?:\w+/g},d={re:c,stripHeadingSlash:function(d){return a.isString(d)&&d.replace(c.headingSlash,"")},routeToRegExp:function(c){return b.Router.prototype._routeToRegExp(c)},isValidArgsArray:function(c){return!a.isEmpty(d.sanitizeArgs(c))},sanitizeArgs:function(c){return a.isObject(c)||a.isArray(c)||(c=[c]),a.without(c,null,void 0)},removeOptionalParams:function(b){return b.replace(c.optionalParams,"")},replaceArgs:function(e,f){return a.forEach(d.sanitizeArgs(f),function(a){e=d.replaceArg(e,a)}),a.forEach(e.match(c.optionalParams),function(a){d.isNamedOrSplatParam(a)&&(e=e.replace(a,""))}),e},replaceArg:function(b,d){return b.indexOf(":")!==-1?b.replace(c.namedParam,d):b.replace(c.splatParams,d)},isNamedOrSplatParam:function(b){return c.namedParam.test(b)||c.splatParams.test(b)},removeTrailingSlash:function(b){return b.replace(c.trailingSlash,"")},removeHeadingSlash:function(d){return a.isString(d)&&d.replace(c.headingSlash,"")},removeParentheses:function(b){return b.replace(c.parentheses,"")},removeRootUrl:function(c,d){return a.isString(c)&&c.replace(d,"")}},e={},f={},g={get:function(b){return f[b]},set:function(b,c){f[b]=c},save:function(c){var d=c.get("name");if(a.has(e,d))throw new Error("[ highway ] Route named "+d+" already declared");e[d]=c},find:function(b){if(b.path){var c=this.get("options");b.path=d.removeHeadingSlash(d.removeRootUrl(b.path,c.root))}return this.findByName(b.name)||this.findByPath(b.path)},findByName:function(c){return c&&a.find(e,function(a){return c===a.get("name")})},findByPath:function(c){return c&&a.find(e,function(a){return a.pathRegExp.test(c)})},getDefinitions:function(){var c={},d={};return a.forEach(e,function(a,b){c[a.get("path")]=b}),a.forEach(e,function(a,b){d[b]=a.get("action")}),a.extend({routes:c},d)}},h=["pushState","hashChange","silent","root"],i={create:function(){var c=b.Router.extend(g.getDefinitions());return new c},start:function(d){return b.History.started?null:b.history.start(a.pick(d,h))},restart:function(){b.history.stop(),b.history.start()}},j={send:function(c,d,e,f){if(!a.isArray(d))throw new Error("[ highway ] Route events definition for "+c+" needs to be an Array");var h=g.get("options"),i=h.dispatcher;if(!i)throw new Error("[ highway ] No dispatcher has been declared to trigger events");d.forEach(function(b){a.isString(b)&&(b={name:b}),e=b.args||b.params||e,e.route=c,e.path=f,i.trigger.apply(i,[b.name].concat(e))})}},k=["403","404"],l={name:null,path:null,action:null},m={trigger:!0,replace:!1};n.prototype={get:function(b){return this.definition[b]},set:function(b,c){this.definition[b]=c},parse:function(b){var c=this.get("path");return d.isValidArgsArray(b)?(c=d.replaceArgs(c,b),c=d.removeTrailingSlash(d.removeParentheses(c))):d.removeOptionalParams(c)},configure:function(){var c=this.definition,e=c.name,f=c.path;f&&!a.includes(k,e)&&(this.set("path",d.stripHeadingSlash(this.get("path"))),this.pathRegExp=d.routeToRegExp(this.get("path"))),this.set("action",this.getActionWrapper())},execute:function(){for(var b=[],c=arguments.length;c--;)b[c]=arguments[c];this.get("action").apply(void 0,b)},getActionWrapper:function(){var b=this.definition,c=b.name,d=b.action,e=b.events,f=b.path;return function(){for(var b=[],g=arguments.length;g--;)b[g]=arguments[g];e&&j.send(c,e,b,f),d.apply(void 0,b)}},getNavigateOptions:function(c){return a.extend({},m,a.pick(c,["trigger","replace"]))}};var o={pushState:!0,root:"",hashChange:!0,silent:!1,debug:!1,dispatcher:null},p=function(){var a=g.findByName("404");if(!a)throw new Error("[ highway ] 404! Landing route is not registered");a.execute()},q=null,r={start:function(c){c=a.extend({},o,c),g.set("options",c),this.router=i.create();var d=i.start(c);d||c.silent||p()},route:function a(b){var a=new n(b);g.save(a),this.router&&a.get("path")&&this.router.route(a.get("path"),a.get("name"),a.get("action"))},go:function(c){if(!a.isString(c)&&!a.isObject(c))throw new Error('[ highway.go ] Navigate option needs to be a string or an object, got "'+c+'"');if(a.isObject(c)&&!c.name&&!c.path)throw new Error('[ highway.go ] Navigate object is missing a "name" or "path" key');if(a.isString(c)&&(c={name:c}),1==c.bypass&&c.path)return this.router.navigate(c.path,!0);var d=g.find(c);return d?(c.path||(c.path=d.parse(c.args||c.params)),this.router.navigate(c.path,d.getNavigateOptions(c)),c.force&&q&&d.get("name")===q.get("name")&&this.reload(),q=d,!0):(p(),!1)},reload:i.restart,restart:i.restart};return r});